```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Prince Career Institute</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      color-scheme: light dark;
      --bg:#ffffff; --fg:#1f2328; --muted:#6e7781; --card:#f6f8fa; --border:#d0d7de;
      --accent:#2d6cdf; --accent2:#ffb02e; --danger:#d63d45; --success:#2fad65;
      --overlay:rgba(0,0,0,0.55);
    }
    [data-theme="dark"] {
      --bg:#0f1115; --fg:#e6edf3; --muted:#9da7b1; --card:#161b22; --border:#30363d;
      --accent:#82aaff; --accent2:#ffc764; --danger:#ff6b6b; --success:#63da7a;
      --overlay:rgba(0,0,0,0.7);
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Arial}
    header{display:flex;justify-content:space-between;align-items:center;padding:10px 16px;background:var(--card);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:5}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700}
    .brand-logo{width:28px;height:28px;border-radius:6px;background:linear-gradient(135deg,var(--accent),var(--accent2))}
    .header-actions{display:flex;gap:8px;align-items:center}
    button{background:var(--accent);color:#fff;border:none;border-radius:8px;padding:8px 12px;font-weight:600;cursor:pointer}
    .btn-secondary{background:transparent;color:var(--fg);border:1px solid var(--border)}
    .btn-danger{background:var(--danger)} .btn-success{background:var(--success)}
    button:disabled{opacity:.5;cursor:not-allowed}
    .banner{display:none;background:#fff7cc;color:#7a5b00;padding:8px 16px;border-bottom:1px solid var(--border)}
    .app{display:grid;grid-template-columns:240px 1fr 320px; height:calc(100vh - 60px)}
    .col{border-right:1px solid var(--border);overflow:hidden;background:var(--bg)} .col:last-child{border-right:none}
    .channels{display:flex;flex-direction:column;height:100%}
    .channels-header,.chat-header,.right-header{padding:12px;background:var(--card);border-bottom:1px solid var(--border)}
    .channel-list{overflow-y:auto;padding:8px}
    .channel{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border-radius:8px;cursor:pointer}
    .channel span.name{font-weight:800;letter-spacing:0.5px}
    .channel.active{background:var(--card)} .badge{background:#eef2ff;color:#2d3a7c;border-radius:999px;padding:2px 8px;font-size:12px}
    .chat{display:flex;flex-direction:column;height:100%}
    .messages{flex:1;overflow-y:auto;padding:12px}
    .message{background:var(--card);border-radius:8px;padding:8px 10px;margin-bottom:10px}
    .msg-head{display:flex;gap:8px;align-items:center}
    .msg-author{font-weight:700}
    .msg-meta{margin-left:auto;color:var(--muted);font-size:12px}
    .msg-body{margin-top:6px;white-space:pre-wrap;word-wrap:break-word}
    .msg-attachment img, .msg-attachment video, .msg-attachment audio{max-width:100%;border-radius:8px;margin-top:8px}
    .msg-actions{display:flex;gap:6px;margin-top:6px;flex-wrap:wrap}
    .reactions{display:flex;gap:6px;margin-top:6px}
    .reaction{background:transparent;color:var(--fg);border:1px solid var(--border);border-radius:999px;padding:4px 8px;font-size:12px;cursor:pointer}
    .composer{border-top:1px solid var(--border);padding:10px;background:var(--card)}
    .composer-row{display:grid;grid-template-columns:1fr auto auto auto auto;gap:8px;align-items:center}
    textarea,input,select{background:var(--bg);color:var(--fg);border:1px solid var(--border);border-radius:8px;padding:10px}
    .overlay{position:fixed;inset:0;background:var(--overlay);display:none;align-items:center;justify-content:center;z-index:1000}
    .overlay.active{display:flex}
    .modal{background:var(--bg);border:1px solid var(--border);border-radius:12px;width:95%;max-width:640px}
    .modal-header,.modal-footer{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .modal-footer{border-top:1px solid var(--border);border-bottom:none;justify-content:flex-end;gap:8px}
    .modal-body{padding:16px;display:grid;gap:10px}
    .note{font-size:12px;color:var(--muted)}
    .hidden{display:none !important}
    .avatar{width:28px;height:28px;border-radius:999px;object-fit:cover}
    .selectable.selected{outline:2px solid var(--accent)}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px;color:var(--muted)}
    @media(max-width:960px){.app{grid-template-columns:1fr}.channels,.right-panel{display:none}.channels.show,.right-panel.show{display:block}}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="brand-logo" aria-hidden="true"></div>
      <div id="site-title">Prince Career Institute</div>
    </div>
    <div class="header-actions">
      <button id="themeToggle" class="btn-secondary">Theme</button>
      <button id="galleryOpenBtn" class="btn-secondary">Gallery</button>
      <button id="helpOpenBtn" class="btn-secondary">Help</button>
      <button id="profileOpenBtn" class="btn-secondary">Profile</button>
      <button id="ownerPanelBtn" class="btn-secondary hidden">Owner</button>
      <button id="adminPanelBtn" class="btn-secondary hidden">Admin</button>
      <button id="logoutBtn" class="btn-danger">Logout</button>
    </div>
  </header>

  <div id="fallbackBanner" class="banner">IndexedDB unavailable. Falling back to localStorage.</div>

  <main class="app">
    <aside class="col channels" id="channelsCol">
      <div class="channels-header">
        <strong>Channels</strong>
        <div style="display:flex;gap:8px"><button id="toggleLeftMobile" class="btn-secondary">Toggle</button></div>
      </div>
      <div id="channelList" class="channel-list"></div>
    </aside>

    <section class="col chat">
      <div class="chat-header">
        <div style="display:flex;gap:8px;align-items:center">
          <strong id="currentChannelName">GENERAL</strong>
          <span id="unreadBadge" class="badge hidden">0 unread</span>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="olderBtn" class="btn-secondary">Load older</button>
          <span id="typingIndicator" class="note"></span>
        </div>
      </div>
      <div id="messages" class="messages" aria-live="polite"></div>
      <div class="composer">
        <div class="composer-row">
          <textarea id="messageInput" rows="2" placeholder="Type a message"></textarea>
          <div class="upload">
            <button id="uploadBtn" class="btn-secondary">Upload</button>
            <input id="fileInput" type="file" accept="image/*,video/*,audio/*"/>
          </div>
          <button id="voiceDictateBtn" class="btn-secondary">üéôÔ∏è Dictate</button>
          <button id="voiceRecordBtn" class="btn-secondary">‚è∫Ô∏è Record</button>
          <button id="sendBtn" class="btn">Send</button>
        </div>
        <div id="composerHelp" class="note">Images: Students ‚â§2MB, Teachers ‚â§5MB, Admin/Owner ‚â§50MB.</div>
      </div>
    </section>

    <aside class="col right-panel" id="rightCol">
      <div class="right-header">
        <div style="display:flex;gap:8px;align-items:center">
          <strong>Members & Pinned</strong>
          <button id="toggleRightMobile" class="btn-secondary">Toggle</button>
        </div>
      </div>
      <div class="messages" id="rightContent">
        <div class="message">
          <div class="msg-head"><strong>Members</strong></div>
          <div id="memberList"></div>
        </div>
        <div class="message">
          <div class="msg-head"><strong>Pinned</strong></div>
          <div id="pinnedList"></div>
        </div>
        <div class="message">
          <div class="msg-head"><strong>Teacher section</strong></div>
          <div class="note">Visible to all. Editable only by Teacher and Owner.</div>
          <textarea id="teacherEdit" rows="4" class="hidden" placeholder="Write teacher notes..."></textarea>
          <div id="teacherView">No content yet.</div>
          <div style="margin-top:8px"><button id="teacherSaveBtn" class="btn hidden">Save</button></div>
        </div>
      </div>
    </aside>
  </main>

  <!-- Auth overlay -->
  <div id="authOverlay" class="overlay active">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-header">
        <strong>Welcome</strong>
        <button id="authOverlayInfoBtn" class="btn-secondary">Help</button>
      </div>
      <div class="modal-body">
        <p>Choose an option to continue.</p>
        <div style="display:flex;gap:8px">
          <button id="openLoginBtn" class="btn">Login</button>
          <button id="openSignupBtn" class="btn btn-success">Sign up</button>
        </div>
        <p class="note">Invite password is required to create any account.</p>
      </div>
      <div class="modal-footer"><button class="btn-secondary" disabled>Close</button></div>
    </div>
  </div>

  <!-- Login Modal -->
  <div id="loginModal" class="overlay">
    <div class="modal">
      <div class="modal-header">
        <strong>Login</strong>
        <button id="loginCancelBtn" class="btn-secondary">Cancel</button>
      </div>
      <div class="modal-body">
        <label>Username <input id="loginUsername" autocomplete="username"/></label>
        <label>Password <input id="loginPassword" type="password" autocomplete="current-password"/></label>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="loginSubmitBtn" class="btn">Login</button>
          <button id="loginCloseBtn" class="btn-secondary">Close</button>
        </div>
        <p class="note">Forgot password? Contact support: princecareerinstitute8624@gmail.com</p>
      </div>
    </div>
  </div>

  <!-- Signup Modal -->
  <div id="signupModal" class="overlay">
    <div class="modal">
      <div class="modal-header">
        <strong>Sign up</strong>
        <button id="signupCancelBtn" class="btn-secondary">Cancel</button>
      </div>
      <div class="modal-body">
        <label>Username <input id="signupUsername" autocomplete="username"/></label>
        <label>Display name <input id="signupDisplayName"/></label>
        <label>Class
          <select id="signupClass"><option value="">Select class</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option><option>11</option><option>12</option></select>
        </label>
        <label>Gender
          <select id="signupGender">
            <option value="">Select gender</option>
            <option>Male</option><option>Female</option><option>Others</option>
          </select>
        </label>
        <label>Password <input id="signupPassword" type="password" autocomplete="new-password"/></label>
        <label>Confirm <input id="signupConfirm" type="password" autocomplete="new-password"/></label>
        <label>Security question <input id="signupSecQ"/></label>
        <label>Security answer <input id="signupSecA"/></label>
        <label>Website invite password <input id="signupInvite" type="password" placeholder="Required for any role"/></label>

        <div style="border-top:1px solid var(--border);margin:8px 0"></div>

        <label>Desired role
          <select id="signupRole">
            <option>Student</option>
            <option>Teacher</option>
            <option>Admin</option>
            <option>Owner</option>
          </select>
        </label>
        <label id="rolePasswordRow" class="hidden">Role password
          <input id="signupRolePassword" type="password" placeholder="Enter role password"/>
        </label>

        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="signupSubmitBtn" class="btn btn-success">Create account</button>
          <button id="signupCloseBtn" class="btn-secondary">Close</button>
        </div>
        <p class="note">Student does not need a role password. Teacher/Admin require approval. Owner can create immediately with correct owner password.</p>
      </div>
    </div>
  </div>

  <!-- Gallery Modal -->
  <div id="galleryModal" class="overlay">
    <div class="modal">
      <div class="modal-header"><strong>Gallery</strong><button id="galleryCloseBtn" class="btn-secondary">Close</button></div>
      <div class="modal-body">
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <select id="galleryFilterChannel"><option value="">All channels</option></select>
          <select id="galleryFilterUser"><option value="">All uploaders</option></select>
        </div>
        <div id="galleryGrid" class="messages" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px"></div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="galleryRemoveBtn" class="btn-danger">Remove selected (Owner/Admin)</button>
        </div>
        <div class="note">Tip: Click a tile to select. Large audio/video show an info note if inline preview is disabled.</div>
      </div>
    </div>
  </div>

  <!-- Profile Modal -->
  <div id="profileModal" class="overlay">
    <div class="modal">
      <div class="modal-header"><strong>Profile</strong><button id="profileCloseBtn" class="btn-secondary">Close</button></div>
      <div class="modal-body">
        <div style="display:flex;gap:12px;align-items:center">
          <img id="profilePhoto" alt="Profile photo" width="64" height="64" class="avatar"/>
          <div>
            <button class="btn-secondary" onclick="document.getElementById('profilePhotoInput').click()">Upload DP</button>
            <input id="profilePhotoInput" type="file" accept="image/*" class="hidden"/>
          </div>
        </div>
        <label>Display name <input id="profileDisplayName"/></label>
        <label>Bio <textarea id="profileBio" rows="3"></textarea></label>
        <label>Role <input id="profileRole" disabled/></label>
        <label>Class <input id="profileClass" disabled/></label>
        <label>Gender <input id="profileGender" disabled/></label>
        <label>Security question <input id="profileSecQ"/></label>
        <label>Security answer <input id="profileSecA"/></label>
        <div style="margin-top:8px"><button id="profileSaveBtn" class="btn">Save</button></div>
      </div>
    </div>
  </div>

  <!-- Member view Modal (bio) -->
  <div id="memberViewModal" class="overlay">
    <div class="modal">
      <div class="modal-header"><strong id="memberViewName">Member</strong><button id="memberViewCloseBtn" class="btn-secondary">Close</button></div>
      <div class="modal-body">
        <div style="display:flex;gap:12px;align-items:center">
          <img id="memberViewPhoto" alt="Member photo" width="64" height="64" class="avatar"/>
          <div class="pill" id="memberViewRole"></div>
          <div class="pill" id="memberViewClass"></div>
          <div class="pill" id="memberViewGender"></div>
        </div>
        <div style="margin-top:8px">
          <strong>Bio</strong>
          <div id="memberViewBio" class="message" style="margin-top:4px"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Admin Panel -->
  <div id="adminPanelModal" class="overlay">
    <div class="modal">
      <div class="modal-header"><strong>Admin panel</strong><button id="adminPanelCloseBtn" class="btn-secondary">Close</button></div>
      <div class="modal-body">
        <div class="message">
          <div class="msg-head"><strong>Flagged messages</strong></div>
          <div id="flaggedList"></div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="flaggedReviewBtn" class="btn">Mark reviewed</button>
            <button id="flaggedDeleteBtn" class="btn-danger">Delete selected</button>
          </div>
        </div>
        <div class="message">
          <div class="msg-head"><strong>Pending approvals (Teacher/Admin)</strong></div>
          <div id="pendingList"></div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="pendingApproveBtn" class="btn">Approve selected</button>
            <button id="pendingRejectBtn" class="btn-danger">Reject selected</button>
          </div>
        </div>
        <div class="message">
          <div class="msg-head"><strong>CSV export</strong></div>
          <div style="display:flex;gap:8px">
            <select id="csvChannelSelect"></select>
            <button id="csvExportBtn" class="btn">Export CSV</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Owner Panel -->
  <div id="ownerPanelModal" class="overlay">
    <div class="modal">
      <div class="modal-header"><strong>Owner panel</strong><button id="ownerPanelCloseBtn" class="btn-secondary">Close</button></div>
      <div class="modal-body">
        <div class="message">
          <div class="msg-head"><strong>Role management</strong></div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <select id="roleUserSelect"></select>
            <select id="roleSelect"><option>Student</option><option>Teacher</option><option>Admin</option><option>Owner</option></select>
            <button id="roleApplyBtn" class="btn">Apply</button>
          </div>
        </div>
        <div class="message">
          <div class="msg-head"><strong>Account controls</strong></div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <select id="accountUserSelect"></select>
            <input id="banDurationInput" type="number" min="1" max="365" placeholder="Ban days"/>
            <button id="banApplyBtn" class="btn-danger">Temp ban</button>
            <button id="unbanApplyBtn" class="btn btn-success">Unban</button>
            <button id="deleteAccountBtn" class="btn-danger">Delete account</button>
          </div>
          <div class="note">Deleting an account removes user and their media/messages. Temp ban prevents login and posting until expiry.</div>
        </div>
        <div class="message">
          <div class="msg-head"><strong>Banned words</strong></div>
          <textarea id="bannedWordsEdit" rows="3"></textarea>
          <div style="margin-top:8px"><button id="bannedWordsSaveBtn" class="btn">Save</button></div>
        </div>
        <div class="message">
          <div class="msg-head"><strong>Export / Import</strong></div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="fullExportBtn" class="btn">Export JSON</button>
            <label class="btn-secondary" style="cursor:pointer">Import JSON<input id="fullImportInput" type="file" accept="application/json" class="hidden"/></label>
            <select id="importMode"><option value="merge">Merge</option><option value="replace">Replace</option></select>
          </div>
        </div>
        <div class="message">
          <div class="msg-head"><strong>Clear all data</strong></div>
          <div style="display:flex;gap:8px"><input id="confirmClearInput" placeholder="Type CONFIRM"/><button id="clearAllBtn" class="btn-danger">Clear</button></div>
        </div>
        <div class="message">
          <div class="msg-head"><strong>Audit log</strong></div>
          <div id="auditLog"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Help Modal -->
  <div id="helpModal" class="overlay">
    <div class="modal">
      <div class="modal-header"><strong>Help & Support</strong><button id="helpCloseBtn" class="btn-secondary">Close</button></div>
      <div class="modal-body">
        <p><strong>Signup:</strong> Invite password required for any role. Student needs no role password. Teacher/Admin requests go to Admin/Owner for approval. Owner can create immediately with correct owner password.</p>
        <p><strong>Roles:</strong> Owner can promote/demote via Owner panel.</p>
        <p><strong>Teacher channel:</strong> Only Teacher/Owner can post there.</p>
        <p><strong>Anti-abuse:</strong> Banned words are blocked or auto-censored. Repeated spam and flood are prevented.</p>
        <p><strong>Realtime:</strong> Messages, pins, media update live‚Äîno manual refresh needed.</p>
        <p><strong>Voice messages:</strong> Record, then press Send to upload and play.</p>
      </div>
    </div>
  </div>

  <script>
    // ===== Config =====
    const SITE_TITLE = "Prince Career Institute";
    const INVITE_PW = "8624";
    const TEACHER_PW = "99663355";
    const ADMIN_PW = "2244882480";
    const OWNER_PW = "MiroxBhaiXCynoxBhai@8745-1234";
    const MESSAGE_RATE_LIMIT_MS = 3000;
    const EDIT_WINDOW_MS = 2 * 60 * 1000;
    const LIMITS = { Student:2, Teacher:5, Admin:50, Owner:50 };
    const CHANNELS = [
      { id:"general", name:"GENERAL" }, { id:"announcements", name:"ANNOUNCEMENTS" },
      { id:"homework", name:"HOMEWORK" }, { id:"media", name:"MEDIA" },
      { id:"promotion", name:"PROMOTION" }, { id:"teacher", name:"TEACHER" }
    ];
    const ROLES = { Owner:"Owner", Admin:"Admin", Teacher:"Teacher", Student:"Student" };
    const PERM = {
      Owner:{ deleteAny:true, pinAny:true, editTeacher:true, exportImport:true },
      Admin:{ deleteAny:true, pinAny:false, editTeacher:false, exportImport:false },
      Teacher:{ deleteAny:false, pinAny:false, editTeacher:true, exportImport:false },
      Student:{ deleteAny:false, pinAny:false, editTeacher:false, exportImport:false }
    };
    const REACTIONS = ["üëç","‚ù§Ô∏è","üòÇ"];

    // Anti-spam configs
    const FLOOD_WINDOW_MS = 60 * 1000;
    const FLOOD_MAX_MESSAGES = 5; // per user per minute
    const DUPLICATE_WINDOW_MS = 2 * 60 * 1000; // same text duplicate window

    // ===== Utils =====
    const qs = s => document.querySelector(s);
    const qsa = s => Array.from(document.querySelectorAll(s));
    const uid = () => crypto.randomUUID();
    const now = () => Date.now();
    const fmt = ms => new Date(ms).toLocaleString();
    async function sha256Hex(str){const buf=await crypto.subtle.digest("SHA-256",new TextEncoder().encode(str));return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("")}
    function escapeHTML(s){const d=document.createElement("div");d.innerText=s??"";return d.innerHTML}
    function isImage(t){return /^image\//.test(t||"")} function isAudio(t){return /^audio\//.test(t||"")} function isVideo(t){return /^video\//.test(t||"")}
    async function blobToBase64(blob){return new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result);r.onerror=rej;r.readAsDataURL(blob);})}
    async function imageThumb(file,maxW=320,maxH=320){return new Promise((res,rej)=>{const img=new Image();img.onload=()=>{const c=document.createElement("canvas"),ctx=c.getContext("2d");let w=img.width,h=img.height;const r=Math.min(maxW/w,maxH/h,1);w=Math.floor(w*r);h=Math.floor(h*r);c.width=w;c.height=h;ctx.drawImage(img,0,0,w,h);res(c.toDataURL("image/jpeg",0.8));};img.onerror=rej;img.src=URL.createObjectURL(file);})}

    // Device fingerprint (weak, client-only)
    function getDeviceId(){
      let id = localStorage.getItem("pci_device_id");
      if(!id){ id = uid(); localStorage.setItem("pci_device_id", id); }
      return id;
    }

    // ===== DB (IndexedDB with localStorage fallback) =====
    const DB = {
      db:null, fallback:false, name:"PCI_DB", version:2,
      async init(){
        if(!("indexedDB" in window)){this.fallback=true;qs("#fallbackBanner").style.display="block";return;}
        const req = indexedDB.open(this.name, this.version);
        req.onupgradeneeded = ev => {
          const db = ev.target.result;
          if(!db.objectStoreNames.contains("users")){const s=db.createObjectStore("users",{keyPath:"id"});s.createIndex("username","username",{unique:true});s.createIndex("deviceId","deviceId");s.createIndex("role","role");}
          if(!db.objectStoreNames.contains("sessions")) db.createObjectStore("sessions",{keyPath:"id"});
          if(!db.objectStoreNames.contains("messages")){const s=db.createObjectStore("messages",{keyPath:"id"});s.createIndex("channelId_createdAt",["channelId","createdAt"]);s.createIndex("flagged","flagged");s.createIndex("senderId_createdAt",["senderId","createdAt"]);s.createIndex("senderId_text",["senderId","text"]); }
          if(!db.objectStoreNames.contains("media")){const s=db.createObjectStore("media",{keyPath:"id"});s.createIndex("channelId","channelId");s.createIndex("uploaderId","uploaderId");}
          if(!db.objectStoreNames.contains("settings")) db.createObjectStore("settings",{keyPath:"key"});
          if(!db.objectStoreNames.contains("pins")) db.createObjectStore("pins",{keyPath:"id"});
          if(!db.objectStoreNames.contains("audit")) db.createObjectStore("audit",{keyPath:"id"});
          if(!db.objectStoreNames.contains("pending")) db.createObjectStore("pending",{keyPath:"id"}); // signup approvals
        };
        this.db = await new Promise((res,rej)=>{req.onsuccess=()=>res(req.result);req.onerror=()=>rej(req.error);});
      },
      async put(store,val){
        if(this.fallback){const k="pci_"+store;const arr=JSON.parse(localStorage.getItem(k)||"[]");const idx=arr.findIndex(x=>(x.id??x.key)===(val.id??val.key));if(idx>=0)arr[idx]=val;else arr.push(val);localStorage.setItem(k,JSON.stringify(arr));return;}
        await new Promise((res,rej)=>{const tx=this.db.transaction(store,"readwrite");tx.objectStore(store).put(val);tx.oncomplete=res;tx.onerror=()=>rej(tx.error);});
      },
      async get(store,key){
        if(this.fallback){const arr=JSON.parse(localStorage.getItem("pci_"+store)||"[]");return arr.find(x=>(x.id??x.key)===key);}
        return await new Promise((res,rej)=>{const tx=this.db.transaction(store,"readonly");const r=tx.objectStore(store).get(key);r.onsuccess=()=>res(r.result);r.onerror=()=>rej(r.error);});
      },
      async del(store,key){
        if(this.fallback){const k="pci_"+store;const arr=JSON.parse(localStorage.getItem(k)||"[]").filter(x=>(x.id??x.key)!==key);localStorage.setItem(k,JSON.stringify(arr));return;}
        await new Promise((res,rej)=>{const tx=this.db.transaction(store,"readwrite");tx.objectStore(store).delete(key);tx.oncomplete=res;tx.onerror=()=>rej(tx.error);});
      },
      async all(store){
        if(this.fallback){return JSON.parse(localStorage.getItem("pci_"+store)||"[]");}
        return await new Promise((res,rej)=>{const tx=this.db.transaction(store,"readonly");const r=tx.objectStore(store).getAll();r.onsuccess=()=>res(r.result||[]);r.onerror=()=>rej(r.error);});
      },
      async index(store,indexName,query){
        const all = await this.all(store);
        if(indexName==="channelId_createdAt"){const [ch,ts]=query;return all.filter(x=>x.channelId===ch && x.createdAt<=ts).sort((a,b)=>b.createdAt-a.createdAt);}
        if(indexName==="flagged"){return all.filter(x=>x.flagged).sort((a,b)=>b.createdAt-a.createdAt);}
        if(indexName==="senderId_createdAt"){const [sid,after]=query;return all.filter(x=>x.senderId===sid && x.createdAt>=after); }
        if(indexName==="senderId_text"){const [sid,text,after]=query;return all.filter(x=>x.senderId===sid && x.text===text && x.createdAt>=after); }
        return all;
      }
    };

    // ===== Session =====
    const Session = {
      async load(){const raw=localStorage.getItem("pci_session");if(!raw) return null;try{const s=JSON.parse(raw);const u=await DB.get("users",s.userId);return u||null;}catch{return null}},
      async save(userId){const s={id:uid(),userId,token:uid(),lastActive:now()};await DB.put("sessions",s);localStorage.setItem("pci_session",JSON.stringify(s));},
      async clear(){localStorage.removeItem("pci_session");}
    };

    // ===== BroadcastChannel =====
    const bc = ("BroadcastChannel" in window)? new BroadcastChannel("pci_bc"):null;
    function broadcast(type,payload={}){ if(bc) bc.postMessage({type,...payload}); }
    if(bc){
      bc.onmessage = (ev)=>{
        const { type } = ev.data || {};
        if (type === "refresh-messages") renderMessages();
        if (type === "refresh-members") renderMembers();
        if (type === "refresh-pins") renderPins();
        if (type === "refresh-gallery") populateGallery();
        if (type === "typing") showTypingIndicator(ev.data.channelId, ev.data.userId);
        if (type === "refresh-pending") loadPending();
      };
    }

    // ===== State =====
    let currentUser=null;
    let currentChannelId="general";
    let bannedWords=["badword","spam","offensive"];
    let lastMessageSentAt=0;
    let recording=null; // MediaRecorder or "ready"
    let recordedChunks=[];
    let floodWindowStart = 0;
    let floodCount = 0;

    // ===== Theme =====
    function setTheme(t){document.documentElement.setAttribute("data-theme",t);localStorage.setItem("pci_theme",t);}
    function initTheme(){setTheme(localStorage.getItem("pci_theme")||"light");}
    qs("#themeToggle").addEventListener("click",()=>{setTheme((document.documentElement.getAttribute("data-theme")==="light")?"dark":"light")});

    // ===== Overlay helpers =====
    const openOverlay = sel => document.querySelector(sel).classList.add("active");
    const closeOverlay = sel => document.querySelector(sel).classList.remove("active");

    // ===== Auth overlay wiring =====
    qs("#openLoginBtn").addEventListener("click",()=>{openOverlay("#loginModal");qs("#loginUsername").focus();});
    qs("#openSignupBtn").addEventListener("click",()=>{openOverlay("#signupModal");qs("#signupUsername").focus();});
    ["#loginCancelBtn","#loginCloseBtn"].forEach(id=>qs(id).addEventListener("click",()=>{closeOverlay("#loginModal");openOverlay("#authOverlay");}));
    ["#signupCancelBtn","#signupCloseBtn"].forEach(id=>qs(id).addEventListener("click",()=>{closeOverlay("#signupModal");openOverlay("#authOverlay");}));
    qs("#authOverlayInfoBtn").addEventListener("click",()=>openOverlay("#helpModal"));
    qs("#helpOpenBtn").addEventListener("click",()=>openOverlay("#helpModal"));
    qs("#helpCloseBtn").addEventListener("click",()=>closeOverlay("#helpModal"));
    qs("#galleryOpenBtn").addEventListener("click",()=>{if(!currentUser) return alert("Login required."); openOverlay("#galleryModal"); populateGallery();});
    qs("#galleryCloseBtn").addEventListener("click",()=>closeOverlay("#galleryModal"));
    qs("#profileOpenBtn").addEventListener("click",()=>{if(!currentUser) return alert("Login required."); openProfile(); openOverlay("#profileModal");});
    qs("#profileCloseBtn").addEventListener("click",()=>closeOverlay("#profileModal"));
    qs("#adminPanelBtn").addEventListener("click",()=>{if(!(isOwner(currentUser)||isAdmin(currentUser))) return alert("No permission."); openOverlay("#adminPanelModal"); loadFlagged(); populateCsvChannels(); loadPending();});
    qs("#adminPanelCloseBtn").addEventListener("click",()=>closeOverlay("#adminPanelModal"));
    qs("#ownerPanelBtn").addEventListener("click",()=>{if(!isOwner(currentUser)) return alert("No permission."); openOverlay("#ownerPanelModal"); renderMembers(); loadAuditLog(); loadBannedWordsEditor(); populateAccountControls();});
    qs("#ownerPanelCloseBtn").addEventListener("click",()=>closeOverlay("#ownerPanelModal"));
    qs("#memberViewCloseBtn").addEventListener("click",()=>closeOverlay("#memberViewModal"));

    // Show/hide role password on role change
    qs("#signupRole").addEventListener("change",()=>{
      const role = qs("#signupRole").value;
      qs("#rolePasswordRow").classList.toggle("hidden", role==="Student");
    });

    // ===== Signup/Login =====
    async function finishLogin(user){
      // block if deleted or banned
      if (user.deleted) return alert("This account has been deleted.");
      if (user.bannedUntil && now() < user.bannedUntil) return alert("Account is temporarily banned until " + new Date(user.bannedUntil).toLocaleString());
      await Session.save(user.id);
      currentUser=user;
      ["#loginModal","#signupModal","#authOverlay"].forEach(closeOverlay);
      await postLoginInit();
    }
    qs("#signupSubmitBtn").addEventListener("click",async()=>{
      const username=qs("#signupUsername").value.trim();
      const displayName=qs("#signupDisplayName").value.trim();
      const clazz=qs("#signupClass").value.trim();
      const gender=qs("#signupGender").value.trim();
      const password=qs("#signupPassword").value; const confirm=qs("#signupConfirm").value;
      const secQ=qs("#signupSecQ").value.trim(); const secA=qs("#signupSecA").value.trim();
      const invite=qs("#signupInvite").value;
      const role=qs("#signupRole").value;
      const rolePW=qs("#signupRolePassword").value;

      if(!username||!displayName||!clazz||!gender||!password||!confirm||!secQ||!secA||!invite||!role) return alert("All fields are required.");
      if(invite!==INVITE_PW) return alert("Invalid invite password.");
      if(password!==confirm) return alert("Passwords do not match.");

      // Owner can create immediately with correct owner PW
      let immediateCreate = false;
      if (role==="Owner") {
        if(rolePW!==OWNER_PW) return alert("Invalid owner password.");
        immediateCreate = true;
      } else if (role==="Teacher") {
        if(rolePW!==TEACHER_PW) return alert("Invalid teacher password.");
      } else if (role==="Admin") {
        if(rolePW!==ADMIN_PW) return alert("Invalid admin password.");
      }

      const existsUser=(await DB.all("users")).find(u=>u.username===username);
      if(existsUser) return alert("Username exists.");

      // Single-device single-account: block creating if this device already has a user, unless Owner creating Owner account
      const deviceId = getDeviceId();
      const deviceUsers = (await DB.all("users")).filter(u=>u.deviceId===deviceId && !u.deleted);
      if (deviceUsers.length>0 && !immediateCreate) {
        return alert("Single device policy: Only one account per device is allowed.");
      }

      const salt=uid(); const passwordHash=await sha256Hex(`${salt}:${password}`);
      const baseUser = {id:uid(),username,displayName,class:clazz,gender,role,salt,passwordHash,dp:null,dpThumb:null,bio:"",secQ,secA,createdAt:now(),updatedAt:now(),deviceId,deleted:false,bannedUntil:null};

      if (immediateCreate || role==="Student") {
        // create full user
        await DB.put("users",baseUser);
        await DB.put("audit",{id:uid(),who:baseUser.id,when:now(),action:`Signup created (${role})`});
        await finishLogin(baseUser);
      } else {
        // create pending request requiring Admin/Owner approval
        const pending = { id:uid(), username, displayName, class:clazz, gender, roleRequested:role, salt, passwordHash, secQ, secA, deviceId, createdAt:now(), requestedBy:"self" };
        await DB.put("pending", pending);
        await DB.put("audit",{id:uid(),who:pending.id,when:now(),action:`Signup pending (${role}) for ${username}`});
        closeOverlay("#signupModal");
        alert("Signup request submitted. Admin/Owner will approve.");
        broadcast("refresh-pending");
      }
    });

    qs("#loginSubmitBtn").addEventListener("click",async()=>{
      const u=qs("#loginUsername").value.trim(); const p=qs("#loginPassword").value;
      if(!u||!p) return alert("Enter username & password.");
      const user=(await DB.all("users")).find(x=>x.username===u);
      if(!user) return alert("Invalid credentials.");
      if (user.deleted) return alert("This account has been deleted.");
      if (user.bannedUntil && now() < user.bannedUntil) return alert("Account is temporarily banned until " + new Date(user.bannedUntil).toLocaleString());
      const hash=await sha256Hex(`${user.salt}:${p}`); if(hash!==user.passwordHash) return alert("Invalid credentials.");
      await finishLogin(user);
    });

    // ===== Post-login init =====
    async function postLoginInit(){
      const bw=await DB.get("settings","bannedWords"); bannedWords = bw?.value || bannedWords;
      buildChannelList(); renderMembers(); renderPins(); renderTeacherSection(); await renderMessages(true); populateGallery(); enforceUIByRole(); initVoice();
      // reset flood
      floodWindowStart = now();
      floodCount = 0;
    }

    // ===== Channels =====
    function buildChannelList(){
      const box=qs("#channelList"); box.innerHTML="";
      CHANNELS.forEach(ch=>{
        const el=document.createElement("div"); el.className="channel"; el.dataset.id=ch.id;
        el.innerHTML=`<span class="name">${ch.name}</span><span class="badge hidden" id="badge_${ch.id}">0</span>`;
        el.addEventListener("click",()=>switchChannel(ch.id)); box.appendChild(el);
      }); highlightActiveChannel();
    }
    function highlightActiveChannel(){ qsa(".channel").forEach(el=>el.classList.toggle("active",el.dataset.id===currentChannelId)); const label = CHANNELS.find(c=>c.id===currentChannelId)?.name || currentChannelId.toUpperCase(); qs("#currentChannelName").textContent=label; }
    async function switchChannel(id){ currentChannelId=id; highlightActiveChannel(); enforceUIByRole(); await renderMessages(true); }

    // ===== Role helpers =====
    function isOwner(u){return u?.role===ROLES.Owner} function isAdmin(u){return u?.role===ROLES.Admin} function isTeacher(u){return u?.role===ROLES.Teacher}
    function canDeleteAny(u){return !!PERM[u?.role]?.deleteAny} function canPinAny(u){return !!PERM[u?.role]?.pinAny} function canEditTeacher(u){return !!PERM[u?.role]?.editTeacher}
    function uploadLimitMB(u){return LIMITS[u?.role]||2}
    function enforceUIByRole(){
      qs("#ownerPanelBtn").classList.toggle("hidden",!isOwner(currentUser));
      qs("#adminPanelBtn").classList.toggle("hidden",!(isOwner(currentUser)||isAdmin(currentUser)));
      const canEdit = canEditTeacher(currentUser);
      qs("#teacherEdit").classList.toggle("hidden",!canEdit);
      qs("#teacherSaveBtn").classList.toggle("hidden",!canEdit);
      const teacherBlocked = currentChannelId==="teacher" && !(isTeacher(currentUser)||isOwner(currentUser));
      ["#messageInput","#sendBtn","#uploadBtn","#voiceDictateBtn","#voiceRecordBtn"].forEach(sel=>{
        const el=qs(sel); if(el) el.disabled = teacherBlocked;
      });
      qs("#composerHelp").textContent = teacherBlocked ? "Only Teacher/Owner can post in teacher channel." : "Images: Students ‚â§2MB, Teachers ‚â§5MB, Admin/Owner ‚â§50MB.";
    }

    // ===== Members (DP shown; click to view bio) =====
    async function renderMembers(){
      const users=await DB.all("users");
      const activeUsers = users.filter(u=>!u.deleted);
      const list=qs("#memberList"); list.innerHTML="";
      activeUsers.forEach(u=>{
        const el=document.createElement("div"); el.className="message";
        const dp = u.dpThumb || 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28"><rect width="28" height="28" rx="14" fill="#ccc"/></svg>';
        el.innerHTML=`
          <div class="msg-head" style="cursor:pointer">
            <img src="${dp}" alt="${escapeHTML(u.displayName)} DP" class="avatar"/>
            <span class="msg-author">${escapeHTML(u.displayName)}</span>
            <span class="note" style="margin-left:8px">${u.role}</span>
            <span class="msg-meta">Class ${escapeHTML(u.class||"")} ‚Ä¢ ${escapeHTML(u.gender||"")}</span>
          </div>`;
        el.addEventListener("click",()=>openMemberView(u));
        list.appendChild(el);
      });
      // Role manager select
      const sel=qs("#roleUserSelect"); if(sel){ sel.innerHTML=""; activeUsers.forEach(u=>{const o=document.createElement("option"); o.value=u.id; o.textContent=`${u.displayName} (${u.role})`; sel.appendChild(o);}); }
      const sel2=qs("#accountUserSelect"); if(sel2){ sel2.innerHTML=""; activeUsers.forEach(u=>{const o=document.createElement("option"); o.value=u.id; o.textContent=`${u.displayName} (${u.role})`; sel2.appendChild(o);}); }
    }
    function openMemberView(u){
      qs("#memberViewName").textContent = u.displayName;
      qs("#memberViewPhoto").src = u.dpThumb || 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect width="64" height="64" rx="32" fill="#ccc"/></svg>';
      qs("#memberViewRole").textContent = u.role;
      qs("#memberViewClass").textContent = "Class " + (u.class || "");
      qs("#memberViewGender").textContent = u.gender || "";
      qs("#memberViewBio").textContent = u.bio || "No bio provided.";
      openOverlay("#memberViewModal");
    }

    qs("#roleApplyBtn").addEventListener("click",async()=>{
      if(!isOwner(currentUser)) return alert("No permission.");
      const userId=qs("#roleUserSelect").value; const role=qs("#roleSelect").value;
      const u=await DB.get("users",userId); if(!u) return; const old=u.role; u.role=role; u.updatedAt=now();
      await DB.put("users",u); await DB.put("audit",{id:uid(),who:currentUser.id,when:now(),action:`Role change: ${u.displayName} ${old}‚Üí${role}`});
      renderMembers(); enforceUIByRole(); renderTeacherSection();
      broadcast("refresh-members");
      alert(`Role updated: ${u.displayName} ‚Üí ${role}`);
    });

    // ===== Owner account controls (ban/unban/delete) =====
    function populateAccountControls(){ /* select options are already populated by renderMembers */ }
    qs("#banApplyBtn").addEventListener("click",async()=>{
      if(!isOwner(currentUser)) return alert("No permission.");
      const userId=qs("#accountUserSelect").value;
      const days=parseInt(qs("#banDurationInput").value||"0",10);
      if(!userId || !days || days<1) return alert("Select user and valid ban duration (days).");
      const u=await DB.get("users",userId); if(!u) return;
      u.bannedUntil = now() + days*24*60*60*1000;
      await DB.put("users",u);
      await DB.put("audit",{id:uid(),who:currentUser.id,when:now(),action:`Temp ban: ${u.displayName} for ${days} day(s)`});
      renderMembers(); alert("Ban applied.");
    });
    qs("#unbanApplyBtn").addEventListener("click",async()=>{
      if(!isOwner(currentUser)) return alert("No permission.");
      const userId=qs("#accountUserSelect").value;
      const u=await DB.get("users",userId); if(!u) return;
      u.bannedUntil = null;
      await DB.put("users",u);
      await DB.put("audit",{id:uid(),who:currentUser.id,when:now(),action:`Unban: ${u.displayName}`});
      renderMembers(); alert("Unbanned.");
    });
    qs("#deleteAccountBtn").addEventListener("click",async()=>{
      if(!isOwner(currentUser)) return alert("No permission.");
      const userId=qs("#accountUserSelect").value;
      const u=await DB.get("users",userId); if(!u) return;
      if(!confirm(`Delete account '${u.displayName}'? This removes user and media/messages.`)) return;
      // delete user and their data
      const msgs=(await DB.all("messages")).filter(m=>m.senderId===u.id);
      for(const m of msgs){ await DB.del("messages",m.id); if(m.attachmentId) await DB.del("media",m.attachmentId); }
      const media=(await DB.all("media")).filter(me=>me.uploaderId===u.id);
      for(const me of media){ await DB.del("media",me.id); }
      // mark user deleted (keep record for audit)
      u.deleted = true;
      await DB.put("users",u);
      await DB.put("audit",{id:uid(),who:currentUser.id,when:now(),action:`Account deleted: ${u.displayName}`});
      renderMembers(); renderMessages(true); populateGallery();
      broadcast("refresh-members"); broadcast("refresh-messages"); broadcast("refresh-gallery");
      alert("Account deleted.");
    });

    // ===== Teacher section =====
    async function renderTeacherSection(){ const st=await DB.get("settings","teacherContent"); const content=st?.value||""; qs("#teacherView").textContent=content||"No content yet."; qs("#teacherEdit").value=content; }
    qs("#teacherSaveBtn").addEventListener("click",async()=>{
      if(!canEditTeacher(currentUser)) return alert("No permission.");
      await DB.put("settings",{key:"teacherContent",value:qs("#teacherEdit").value}); renderTeacherSection();
      broadcast("refresh-members");
      alert("Teacher section updated.");
    });

    // ===== Messages =====
    function msgBodyHTML(m){
      const text = m.deleted ? "[deleted]" : escapeHTML(m.text||"");
      const edited = m.editedAt ? `<span class="note" style="margin-left:8px">edited</span>` : "";
      const att = m.attachmentId ? `<div class="msg-attachment" id="att_${m.attachmentId}"></div>` : "";
      return `<div class="msg-body">${text}${edited}</div>${att}`;
    }
    function reactionsHTML(m) {
      return `<div class="reactions">
        ${REACTIONS.map(r => {
          const reactors = m.reactions?.[r] || [];
          const count = reactors.length;
          return `<button class="reaction" data-r="${r}" data-id="${m.id}" title="${count}">${r} ${count}</button>`;
        }).join(" ")}
      </div>`;
    }
    function renderMessageElement(m){
      const el=document.createElement("div"); el.className="message";
      const self=currentUser?.id===m.senderId; const canDel=self||canDeleteAny(currentUser); const canPin=canPinAny(currentUser);
      el.innerHTML=`
        <div class="msg-head">
          <span class="msg-author">${escapeHTML(m.senderName)}</span>
          <span class="note" style="margin-left:8px">#${escapeHTML(m.channelId.toUpperCase())}</span>
          <span class="msg-meta">${fmt(m.createdAt)}</span>
        </div>
        ${msgBodyHTML(m)}
        <div class="msg-actions">
          ${self ? `<button class="btn-secondary" data-edit="${m.id}">Edit</button>` : ``}
          ${canDel ? `<button class="btn-danger" data-del="${m.id}">Delete</button>` : ``}
          ${canDel ? `<button class="btn-danger" data-hard="${m.id}">Remove permanently</button>` : ``}
          ${canPin ? `<button class="btn-secondary" data-pin="${m.id}">Pin</button>` : ``}
        </div>
        ${reactionsHTML(m)}
      `;
      if(m.attachmentId) loadAttachmentInto(m.attachmentId, el.querySelector(`#att_${m.attachmentId}`));
      el.querySelectorAll("[data-edit]").forEach(b=>b.addEventListener("click",()=>editMessage(m)));
      el.querySelectorAll("[data-del]").forEach(b=>b.addEventListener("click",()=>softDeleteMessage(m)));
      el.querySelectorAll("[data-hard]").forEach(b=>b.addEventListener("click",()=>hardDeleteMessage(m)));
      el.querySelectorAll("[data-pin]").forEach(b=>b.addEventListener("click",()=>pinMessage(m)));
      el.querySelectorAll(".reaction").forEach(btn=>btn.addEventListener("click",()=>toggleReaction(m, btn.dataset.r)));
      return el;
    }
    async function renderMessages(reset=false){
      const box=qs("#messages"); if(reset) box.dataset.oldestTs=""+now();
      const oldest=parseInt(box.dataset.oldestTs||(""+now()),10);
      const msgs=await DB.index("messages","channelId_createdAt",[currentChannelId,oldest]);
      box.innerHTML=""; msgs.sort((a,b)=>a.createdAt-b.createdAt).forEach(m=>box.appendChild(renderMessageElement(m)));
      box.scrollTop=box.scrollHeight; enforceUIByRole();
    }
    qs("#olderBtn").addEventListener("click",async()=>{
      const box=qs("#messages"); const metas=Array.from(box.querySelectorAll(".msg-meta")).map(n=>Date.parse(n.textContent)).filter(n=>!isNaN(n));
      const oldestRendered=metas.length?Math.min(...metas):now(); box.dataset.oldestTs=String(oldestRendered-1);
      const older=await DB.index("messages","channelId_createdAt",[currentChannelId,oldestRendered-1]);
      older.sort((a,b)=>a.createdAt-b.createdAt).forEach(m=>box.prepend(renderMessageElement(m)));
    });

    // ===== Message actions =====
    async function toggleReaction(m, r) {
      const reactors = m.reactions?.[r] || [];
      const idx = reactors.indexOf(currentUser.id);
      if (idx >= 0) reactors.splice(idx, 1); else reactors.push(currentUser.id);
      m.reactions = { ...(m.reactions || {}), [r]: reactors };
      await DB.put("messages", m);
      renderMessages();
      broadcast("refresh-messages");
    }
    async function editMessage(m){
      if(currentUser.id!==m.senderId) return alert("No permission.");
      if(currentUser.role===ROLES.Student && now()-m.createdAt>EDIT_WINDOW_MS) return alert("Edit window expired.");
      const newText=prompt("Edit your message:", m.text); if(newText==null) return;
      const cleanText = filterAbuse(newText);
      m.text=cleanText; m.editedAt=now();
      await DB.put("messages",m); renderMessages(); broadcast("refresh-messages");
    }
    async function softDeleteMessage(m){const self=currentUser?.id===m.senderId; if(!(self||canDeleteAny(currentUser))) return alert("No permission."); m.deleted=true; await DB.put("messages",m); renderMessages(); broadcast("refresh-messages");}
    async function hardDeleteMessage(m){if(!canDeleteAny(currentUser)) return alert("No permission."); await DB.del("messages",m.id); if(m.attachmentId) await DB.del("media",m.attachmentId); renderMessages(); populateGallery(); broadcast("refresh-messages"); broadcast("refresh-gallery");}
    async function pinMessage(m){if(!canPinAny(currentUser)) return alert("No permission."); await DB.put("pins",{id:uid(),channelId:m.channelId,text:m.text,createdAt:now()}); renderPins(); broadcast("refresh-pins");}

    // ===== Anti-abuse / Anti-spam =====
    function filterAbuse(text){
      if(!text) return text;
      // hard block if banned word present as whole word; else soft replace
      let blocked = false;
      let cleaned = text;
      bannedWords.forEach(w=>{
        if(!w) return;
        const re = new RegExp(`\\b${w}\\b`,"i");
        if(re.test(cleaned)){ blocked = true; cleaned = cleaned.replace(new RegExp(w,"ig"), "****"); }
      });
      if(blocked) {
        // mark typing note
        qs("#typingIndicator").textContent = "Abusive content auto-censored.";
        setTimeout(()=>qs("#typingIndicator").textContent="",1500);
      }
      return cleaned;
    }
    async function checkSpam(text){
      const t = now();
      // simple rate-limit (existing)
      if(t - lastMessageSentAt < MESSAGE_RATE_LIMIT_MS) return "Rate limit: wait a moment.";

      // flood control
      if (t - floodWindowStart > FLOOD_WINDOW_MS) { floodWindowStart = t; floodCount = 0; }
      floodCount++;
      if (floodCount > FLOOD_MAX_MESSAGES) return "Too many messages. Please slow down.";

      // duplicate text by same user in DUPLICATE_WINDOW_MS
      if (text) {
        const recentSame = (await DB.index("messages","senderId_text",[currentUser.id,text, t - DUPLICATE_WINDOW_MS]));
        if (recentSame.length > 0) return "Duplicate message detected. Please modify your message.";
      }
      return null;
    }

    // ===== Composer & sending =====
    qs("#uploadBtn").addEventListener("click",()=>qs("#fileInput").click());
    qs("#messageInput").addEventListener("input",()=>{ if(bc) broadcast("typing",{channelId:currentChannelId,userId:currentUser?.id}); });
    function showTypingIndicator(channelId,userId){
      if(channelId!==currentChannelId) return;
      const me = userId===currentUser?.id ? "You" : "Someone";
      qs("#typingIndicator").textContent = `${me} is typing...`;
      setTimeout(()=>qs("#typingIndicator").textContent="",800);
    }
    qs("#sendBtn").addEventListener("click",async()=>{
      if(!currentUser) return alert("Login required.");
      if(currentUser.bannedUntil && now() < currentUser.bannedUntil) return alert("You are banned until " + new Date(currentUser.bannedUntil).toLocaleString());
      if(currentChannelId==="teacher" && !(isTeacher(currentUser)||isOwner(currentUser))) return alert("Only Teacher/Owner can post in teacher channel.");
      let text=qs("#messageInput").value.trim();
      const file=qs("#fileInput").files[0]||null;
      const hasVoice = recording==="ready";
      if(!text && !file && !hasVoice) return alert("Type a message or attach media.");

      // anti-spam check
      const spamErr = await checkSpam(text);
      if (spamErr) return alert(spamErr);

      // filter/censor abusive words
      text = filterAbuse(text);

      let attachmentId=null;
      // voice message upload
      if(hasVoice){
        const blob=new Blob(recordedChunks,{type:"audio/webm"});
        attachmentId=await storeMedia(blob,"audio/webm","Voice message");
        recordedChunks=[]; recording=null;
      }

      if(file){
        const sizeMB=file.size/(1024*1024); const limit=uploadLimitMB(currentUser);
        if(sizeMB>limit) return alert(`Upload too large for your role. Limit: ${limit}MB.`);
        attachmentId=await storeMedia(file,file.type,file.name);
        qs("#fileInput").value="";
      }

      const msg={id:uid(),channelId:currentChannelId,text,attachmentId,createdAt:now(),senderId:currentUser.id,senderName:currentUser.displayName,deleted:false,editedAt:null,reactions:{},flagged:false};
      // auto-flag if banned word was censored (**** present)
      if (/\*{4}/.test(text)) msg.flagged = true;
      await DB.put("messages",msg);
      qs("#messageInput").value=""; lastMessageSentAt=now();
      renderMessages(); broadcast("refresh-messages");
    });

    // ===== Media store + load =====
    async function storeMedia(fileOrBlob,mime,name){
      const id=uid(); let thumb=null, dataUrl=null;
      if(isImage(mime)){
        const file = fileOrBlob instanceof Blob ? new File([fileOrBlob], name||"image", {type:mime}) : fileOrBlob;
        thumb = await imageThumb(file);
        if(file.size <= 2*1024*1024) dataUrl = await blobToBase64(file);
      } else if(isAudio(mime) || isVideo(mime)){
        const size = fileOrBlob.size || 0;
        if(size <= 5*1024*1024) dataUrl = await blobToBase64(fileOrBlob); // inline for small media
      }
      const item={id,mime,name,createdAt:now(),uploaderId:currentUser.id,channelId:currentChannelId,thumb,inlineDataUrl:dataUrl||null};
      await DB.put("media",item);
      broadcast("refresh-gallery");
      return id;
    }
    async function loadAttachmentInto(attId,container){
      if(!container) return; const m=await DB.get("media",attId); if(!m) return;
      let el;
      if(isImage(m.mime)){el=document.createElement("img"); el.src=m.inlineDataUrl||m.thumb; el.alt=m.name;}
      else if(isAudio(m.mime)){el=document.createElement("audio"); el.controls=true; if(m.inlineDataUrl){el.src=m.inlineDataUrl;} else {const info=document.createElement("div"); info.className="note"; info.textContent="Audio stored offline (inline preview disabled for large files)"; el.appendChild(info);} }
      else if(isVideo(m.mime)){el=document.createElement("video"); el.controls=true; el.style.maxHeight="220px"; if(m.inlineDataUrl){el.src=m.inlineDataUrl;} else {const info=document.createElement("div"); info.className="note"; info.textContent="Video stored offline (inline preview disabled for large files)"; el.appendChild(info);} }
      else {el=document.createElement("div"); el.className="note"; el.textContent="Attachment";}
      container.innerHTML=""; container.appendChild(el);
    }

    // ===== Gallery =====
    async function populateGallery(){
      const items=await DB.all("media"); const grid=qs("#galleryGrid"); grid.innerHTML="";
      const users=await DB.all("users");
      const prevCh=qs("#galleryFilterChannel").value||"";
      const prevU=qs("#galleryFilterUser").value||"";
      qs("#galleryFilterChannel").innerHTML=`<option value="">All channels</option>`+CHANNELS.map(c=>`<option value="${c.id}">${c.id.toUpperCase()}</option>`).join("");
      qs("#galleryFilterUser").innerHTML=`<option value="">All uploaders</option>`+users.filter(u=>!u.deleted).map(u=>`<option value="${u.id}">${escapeHTML(u.displayName)}</option>`).join("");
      qs("#galleryFilterChannel").value = prevCh;
      qs("#galleryFilterUser").value = prevU;
      const chVal=qs("#galleryFilterChannel").value||""; const uVal=qs("#galleryFilterUser").value||"";
      items.forEach(it=>{
        if(chVal && it.channelId!==chVal) return; if(uVal && it.uploaderId!==uVal) return;
        const card=document.createElement("div"); card.className="message selectable"; card.dataset.id=it.id;
        let content="";
        if(isImage(it.mime)) content=`<img src="${it.inlineDataUrl||it.thumb}" alt="${escapeHTML(it.name)}"/>`;
        else if(isAudio(it.mime)) content= it.inlineDataUrl ? `<audio controls src="${it.inlineDataUrl}"></audio>` : `<div class="note">Audio stored offline</div>`;
        else if(isVideo(it.mime)) content= it.inlineDataUrl ? `<video controls src="${it.inlineDataUrl}"></video>` : `<div class="note">Video stored offline</div>`;
        else content=`<div class="note">${escapeHTML(it.name)}</div>`;
        const uploader = users.find(u=>u.id===it.uploaderId)?.displayName || "unknown";
        card.innerHTML = `${content}<div class="note">By ${escapeHTML(uploader)} in #${escapeHTML(it.channelId.toUpperCase())} ‚Äî ${fmt(it.createdAt)}</div>`;
        card.addEventListener("click",()=>card.classList.toggle("selected"));
        grid.appendChild(card);
      });
    }
    qs("#galleryFilterChannel").addEventListener("change",populateGallery);
    qs("#galleryFilterUser").addEventListener("change",populateGallery);
    qs("#galleryRemoveBtn").addEventListener("click",async()=>{
      if(!(isOwner(currentUser)||isAdmin(currentUser))) return alert("No permission.");
      const ids=Array.from(qsa("#galleryGrid .message.selected")).map(el=>el.dataset.id);
      for(const id of ids) await DB.del("media",id);
      populateGallery(); broadcast("refresh-gallery");
    });

    // ===== Pinned (with Unpin) =====
    async function renderPins(){
      const pins=await DB.all("pins"); const box=qs("#pinnedList"); box.innerHTML="";
      pins.forEach(p=>{
        const el=document.createElement("div"); el.className="message";
        const canUnpin=isOwner(currentUser);
        el.innerHTML=`<div class="msg-head"><span class="msg-author">Pinned</span><span class="note" style="margin-left:8px">#${p.channelId.toUpperCase()}</span><span class="msg-meta">${fmt(p.createdAt)}</span></div><div class="msg-body">${escapeHTML(p.text||"")}</div>
          <div class="msg-actions">${canUnpin?`<button class="btn-danger" data-unpin="${p.id}">Unpin</button>`:""}</div>`;
        if(canUnpin){
          el.querySelector(`[data-unpin="${p.id}"]`).addEventListener("click",async()=>{
            await DB.del("pins",p.id); renderPins(); broadcast("refresh-pins");
          });
        }
        box.appendChild(el);
      });
    }

    // ===== Admin panel =====
    async function loadFlagged(){
      const flagged=await DB.index("messages","flagged",true);
      const list=qs("#flaggedList"); list.innerHTML="";
      flagged.forEach(m=>{
        const el=document.createElement("div"); el.className="message selectable"; el.dataset.id=m.id;
        el.innerHTML=`<div class="msg-head"><span class="msg-author">${escapeHTML(m.senderName)}</span><span class="note" style="margin-left:8px">#${escapeHTML(m.channelId.toUpperCase())}</span><span class="msg-meta">${fmt(m.createdAt)}</span></div><div class="msg-body">${escapeHTML(m.text)}</div>`;
        el.addEventListener("click",()=>el.classList.toggle("selected")); list.appendChild(el);
      });
    }
    qs("#flaggedReviewBtn").addEventListener("click",async()=>{
      if(!(isOwner(currentUser)||isAdmin(currentUser))) return alert("No permission.");
      const ids=Array.from(qsa("#flaggedList .selectable.selected")).map(el=>el.dataset.id);
      for(const id of ids){const m=await DB.get("messages",id); if(m){m.flagged=false; await DB.put("messages",m);}}
      loadFlagged(); renderMessages(); broadcast("refresh-messages");
    });
    qs("#flaggedDeleteBtn").addEventListener("click",async()=>{
      if(!(isOwner(currentUser)||isAdmin(currentUser))) return alert("No permission.");
      const ids=Array.from(qsa("#flaggedList .selectable.selected")).map(el=>el.dataset.id);
      for(const id of ids) await DB.del("messages",id);
      loadFlagged(); renderMessages(); broadcast("refresh-messages");
    });
    function populateCsvChannels(){qs("#csvChannelSelect").innerHTML=CHANNELS.map(c=>`<option>${c.id}</option>`).join("")}
    qs("#csvExportBtn").addEventListener("click",async()=>{
      const ch=qs("#csvChannelSelect").value; const msgs=(await DB.all("messages")).filter(m=>m.channelId===ch).sort((a,b)=>a.createdAt-b.createdAt);
      const csv=["id,channelId,text,senderName,createdAt,deleted,editedAt"].concat(
        msgs.map(m=>[m.id,m.channelId,JSON.stringify(m.text||""),JSON.stringify(m.senderName||""),new Date(m.createdAt).toISOString(),!!m.deleted,m.editedAt?new Date(m.editedAt).toISOString():""].join(","))
      ).join("\n");
      const a=document.createElement("a"); a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"})); a.download=`pci_${ch}.csv`; a.click();
    });

    // Pending approvals
    async function loadPending(){
      const list = qs("#pendingList");
      list.innerHTML = "";
      const pendings = await DB.all("pending");
      pendings.forEach(p=>{
        const el = document.createElement("div"); el.className="message selectable"; el.dataset.id = p.id;
        el.innerHTML = `
          <div class="msg-head">
            <span class="msg-author">${escapeHTML(p.displayName)}</span>
            <span class="note" style="margin-left:8px">${escapeHTML(p.roleRequested)}</span>
            <span class="msg-meta">${fmt(p.createdAt)}</span>
          </div>
          <div class="msg-body">Username: ${escapeHTML(p.username)} ‚Ä¢ Class ${escapeHTML(p.class||"")} ‚Ä¢ ${escapeHTML(p.gender||"")}</div>
        `;
        el.addEventListener("click",()=>el.classList.toggle("selected"));
        list.appendChild(el);
      });
    }
    qs("#pendingApproveBtn").addEventListener("click",async()=>{
      if(!(isOwner(currentUser)||isAdmin(currentUser))) return alert("No permission.");
      const ids=Array.from(qsa("#pendingList .selectable.selected")).map(el=>el.dataset.id);
      for(const id of ids){
        const p=await DB.get("pending",id); if(!p) continue;
        const user = { id:uid(), username:p.username, displayName:p.displayName, class:p.class, gender:p.gender, role:p.roleRequested, salt:p.salt, passwordHash:p.passwordHash, dp:null, dpThumb:null, bio:"", secQ:p.secQ, secA:p.secA, createdAt:now(), updatedAt:now(), deviceId:p.deviceId, deleted:false, bannedUntil:null };
        await DB.put("users",user);
        await DB.del("pending",id);
        await DB.put("audit",{id:uid(),who:currentUser.id,when:now(),action:`Approved signup: ${user.username} (${user.role})`});
      }
      loadPending(); renderMembers(); alert("Approved.");
      broadcast("refresh-members"); broadcast("refresh-pending");
    });
    qs("#pendingRejectBtn").addEventListener("click",async()=>{
      if(!(isOwner(currentUser)||isAdmin(currentUser))) return alert("No permission.");
      const ids=Array.from(qsa("#pendingList .selectable.selected")).map(el=>el.dataset.id);
      for(const id of ids){ await DB.del("pending",id); await DB.put("audit",{id:uid(),who:currentUser.id,when:now(),action:`Rejected signup: ${id}`}); }
      loadPending(); alert("Rejected."); broadcast("refresh-pending");
    });

    // ===== Owner tools =====
    function loadBannedWordsEditor(){ qs("#bannedWordsEdit").value = bannedWords.join(", "); }
    qs("#bannedWordsSaveBtn").addEventListener("click",async()=>{
      if(!isOwner(currentUser)) return alert("No permission.");
      bannedWords = qs("#bannedWordsEdit").value.split(",").map(s=>s.trim()).filter(Boolean);
      await DB.put("settings",{key:"bannedWords",value:bannedWords}); alert("Banned words updated.");
    });
    async function loadAuditLog(){ const logs=(await DB.all("audit")).sort((a,b)=>b.when-a.when).slice(0,50); const box=qs("#auditLog"); box.innerHTML="";
      logs.forEach(l=>{const el=document.createElement("div"); el.className="note"; el.textContent=`${fmt(l.when)} ‚Äî ${l.action}`; box.appendChild(el);});
    }
    qs("#fullExportBtn").addEventListener("click",async()=>{
      if(!isOwner(currentUser)) return alert("No permission.");
      const payload={users:await DB.all("users"),messages:await DB.all("messages"),media:await DB.all("media"),settings:await DB.all("settings"),pins:await DB.all("pins"),audit:await DB.all("audit"),pending:await DB.all("pending")};
      const a=document.createElement("a"); a.href=URL.createObjectURL(new Blob([JSON.stringify(payload,null,2)],{type:"application/json"})); a.download=`pci_export_${Date.now()}.json`; a.click();
    });
    qs("#fullImportInput").addEventListener("change",async(e)=>{
      if(!isOwner(currentUser)) { e.target.value=""; return alert("No permission."); }
      const file=e.target.files[0]; if(!file) return;
      const mode=qs("#importMode").value; const text=await file.text(); let data={}; try{data=JSON.parse(text);}catch{return alert("Invalid JSON.");}
      const stores=["users","messages","media","settings","pins","audit","pending"];
      if(mode==="replace"){ for(const s of stores){ for(const item of await DB.all(s)){ await DB.del(s, item.id||item.key); } } }
      for(const s of stores){ const arr=Array.isArray(data[s])?data[s]:[]; for(const item of arr){ await DB.put(s,item); } }
      await DB.put("audit",{id:uid(),who:currentUser.id,when:now(),action:`Imported JSON (${mode})`});
      alert("Import complete."); renderMembers(); renderMessages(); populateGallery(); renderPins(); loadAuditLog(); loadPending();
      broadcast("refresh-members"); broadcast("refresh-messages"); broadcast("refresh-gallery"); broadcast("refresh-pins"); broadcast("refresh-pending");
    });
    qs("#clearAllBtn").addEventListener("click",async()=>{
      if(!isOwner(currentUser)) return alert("No permission.");
      if(qs("#confirmClearInput").value.trim()!=="CONFIRM") return alert("Type CONFIRM to proceed.");
      for(const s of ["users","messages","media","settings","pins","audit","sessions","pending"]){ for(const item of await DB.all(s)){ await DB.del(s, item.id||item.key); } }
      await Session.clear(); alert("All data cleared."); location.reload();
    });

    // ===== Profile =====
    function openProfile(){
      qs("#profilePhoto").src=currentUser.dpThumb||'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect width="64" height="64" rx="32" fill="#ccc"/></svg>';
      qs("#profileDisplayName").value=currentUser.displayName||"";
      qs("#profileBio").value=currentUser.bio||"";
      qs("#profileRole").value=currentUser.role||"";
      qs("#profileClass").value=currentUser.class||"";
      qs("#profileGender").value=currentUser.gender||"";
      qs("#profileSecQ").value=currentUser.secQ||"";
      qs("#profileSecA").value=currentUser.secA||"";
    }
    qs("#profilePhotoInput").addEventListener("change",async(e)=>{
      const file=e.target.files[0]; if(!file||!isImage(file.type)) return alert("Select an image.");
      currentUser.dpThumb=await imageThumb(file,128,128); currentUser.dp=await blobToBase64(file); currentUser.updatedAt=now();
      await DB.put("users",currentUser); qs("#profilePhoto").src=currentUser.dpThumb; renderMembers(); broadcast("refresh-members");
    });
    qs("#profileSaveBtn").addEventListener("click",async()=>{
      currentUser.displayName=qs("#profileDisplayName").value.trim();
      currentUser.bio=qs("#profileBio").value.trim();
      currentUser.secQ=qs("#profileSecQ").value.trim();
      currentUser.secA=qs("#profileSecA").value.trim();
      currentUser.updatedAt=now();
      await DB.put("users",currentUser); renderMembers(); broadcast("refresh-members"); alert("Profile saved.");
    });

    // ===== Voice features =====
    function initVoice(){
      const SpeechRec=window.SpeechRecognition||window.webkitSpeechRecognition;
      const recBtn=qs("#voiceDictateBtn");
      if(!SpeechRec){recBtn.disabled=true; recBtn.title="SpeechRecognition unavailable";}
      else{
        const rec=new SpeechRec(); rec.lang="en-US"; rec.interimResults=false; rec.maxAlternatives=1;
        recBtn.addEventListener("click",()=>rec.start());
        rec.addEventListener("result",(e)=>{const text=e.results[0][0].transcript; qs("#messageInput").value += (qs("#messageInput").value?" ":"")+text;});
      }
      const recordBtn=qs("#voiceRecordBtn");
      if(!navigator.mediaDevices || !window.MediaRecorder){recordBtn.disabled=true; recordBtn.title="MediaRecorder unavailable";}
      else{
        recordBtn.addEventListener("click",async()=>{
          if(!recording){
            try{
              const stream=await navigator.mediaDevices.getUserMedia({audio:true});
              const mr=new MediaRecorder(stream); recordedChunks=[];
              mr.ondataavailable=e=>{if(e.data.size>0) recordedChunks.push(e.data);};
              mr.onstop=async()=>{
                recording="ready";
                alert("Voice recorded. Click Send to upload.");
              };
              mr.start(); recording=mr; recordBtn.textContent="‚èπÔ∏è Stop";
            }catch(e){alert("Microphone unavailable.");}
          } else if(recording instanceof MediaRecorder){
            recording.stop(); recordBtn.textContent="‚è∫Ô∏è Record";
          } else {
            alert("Voice recorded. Click Send to upload.");
          }
        });
      }
    }

    // ===== Logout =====
    qs("#logoutBtn").addEventListener("click",async()=>{
      await Session.clear(); currentUser=null; openOverlay("#authOverlay");
    });

    // ===== Init =====
    (async function init(){
      initTheme();
      await DB.init();
      const u=await Session.load();
      if(u){currentUser=u; closeOverlay("#authOverlay"); await postLoginInit();}
      else { openOverlay("#authOverlay"); }
      qs("#toggleLeftMobile").addEventListener("click",()=>qs("#channelsCol").classList.toggle("show"));
      qs("#toggleRightMobile").addEventListener("click",()=>qs("#rightCol").classList.toggle("show"));
      document.querySelector("title").textContent = SITE_TITLE; qs("#site-title").textContent = SITE_TITLE;
    })();
  </script>
</body>
</html>
```